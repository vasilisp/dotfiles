;; Fail fast: Emacs 30+
(when (< emacs-major-version 30)
  (error "This init requires Emacs 30+ (you have %s)" emacs-version))

;;;; Backups / autosave

(let ((dir (expand-file-name "~/.emacs-backup/")))
  (make-directory dir t)
  (setq backup-directory-alist `(("." . ,dir))))

(setq auto-save-default nil)

;;;; Generic settings

(column-number-mode 1)
(setq-default indent-tabs-mode nil)
(put 'downcase-region 'disabled nil)

;;;; Package management (builtin `package`, MELPA)

(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)

;;;; Text-mode: auto-fill

(add-hook 'text-mode-hook #'auto-fill-mode)

;;;; Mail buffers (mutt / temp messages)

(add-to-list 'auto-mode-alist '("/mutt-"   . mail-mode))
(add-to-list 'auto-mode-alist '("/tmpmsg-" . mail-mode))

;;;; C: Linux-ish formatting

(add-hook 'c-mode-common-hook
          (lambda ()
            (local-set-key (kbd "RET") #'newline-and-indent)))

(defun linux-c-mode ()
  "C mode with adjusted defaults for use with the Linux kernel."
  (interactive)
  (c-mode)
  (c-set-style "K&R")
  (setq-local tab-width 8)
  (setq-local indent-tabs-mode t)
  (setq-local c-basic-offset 8))

(add-to-list 'auto-mode-alist '("\\.[ch]\\'" . linux-c-mode))

;;;; Markdown (optional)

(use-package markdown-mode
    :ensure t
    :mode ("\\.md\\'" "\\.markdown\\'"))

;;;; OCaml tooling (optional, degrades gracefully)

(use-package tuareg
    :ensure t
    :mode ("\\.mli?\\'")
    :custom
    (tuareg-in-indent 0)
    :hook
    (tuareg-mode . (lambda ()
                     (add-hook 'before-save-hook
                               #'delete-trailing-whitespace
                               nil t))))

(when (and (executable-find "opam")
           (not (getenv "OPAM_SWITCH_PREFIX")))
  (ignore-errors
    (dolist (var
              (car
               (read-from-string
                (shell-command-to-string "opam config env --sexp"))))
      (setenv (car var) (cadr var)))))

(let ((op (getenv "OPAM_SWITCH_PREFIX")))
  (when (and op (file-directory-p op))
    (add-to-list 'load-path (expand-file-name "share/emacs/site-lisp" op))
    (add-to-list 'exec-path (expand-file-name "bin" op))))

(when (locate-library "ocp-indent")
  (autoload 'ocp-setup-indent "ocp-indent" "Indent OCaml using ocp-indent." t)
  (add-hook 'tuareg-mode-hook #'ocp-setup-indent))

(when (locate-library "merlin")
  (autoload 'merlin-mode "merlin" "Merlin mode." t)
  (add-hook 'tuareg-mode-hook #'merlin-mode))

(when (locate-library "utop")
  (autoload 'utop "utop" "Toplevel for OCaml." t))

(when (locate-library "camldebug")
  (autoload 'camldebug "camldebug" "Run the Caml debugger." t))

;;;; Server

(require 'server)
(setq server-name "std")
(unless (server-running-p)
  (server-start))

(defun shutdown ()
  "Save buffers and quit Emacs."
  (interactive)
  (save-some-buffers)
  (kill-emacs))

;;;; Compilation keybindings

(global-set-key (kbd "C-c c") #'compile)
(global-set-key (kbd "C-c r") #'recompile)

;;;; Go (optional)

(add-hook 'go-mode-hook
          (lambda ()
            ;; lsp-mode is optional
            (when (fboundp 'lsp-deferred)
              (lsp-deferred))

            ;; gofmt is part of go-mode; buffer-local hook
            (when (fboundp 'gofmt-before-save)
              (add-hook 'before-save-hook #'gofmt-before-save nil t))

            (setq-local tab-width 4)
            (setq-local standard-indent 4)
            (setq-local indent-tabs-mode nil)))

;; --- Rust (optional binaries) ---

(use-package rust-mode
    :ensure t
    :mode ("\\.rs\\'")
    :hook
    (rust-mode . (lambda ()
                   ;; Enable rustfmt-on-save only if rustfmt exists
                   (when (executable-find "rustfmt")
                     (setq-local rust-format-on-save t)))))

(use-package cargo
    :ensure t
    :hook
    ;; Only enable cargo-minor-mode if cargo exists
    (rust-mode . (lambda ()
                   (when (executable-find "cargo")
                     (cargo-minor-mode 1)))))

(use-package eglot
    :ensure nil ;; built-in on Emacs 30
    :hook
    ;; Only enable LSP if rust-analyzer exists
    (rust-mode . (lambda ()
                   (when (executable-find "rust-analyzer")
                     (eglot-ensure)))))

(with-eval-after-load 'eglot
  (setq eglot-send-changes-idle-time 1.0)
  (add-to-list
   'eglot-workspace-configuration
   '(:rust-analyzer
     (:procMacro (:enable :json-false)
      :cargo (:allFeatures :json-false
              :features []
              :allTargets :json-false)
      :checkOnSave (:enable t
                    :command "check"
                    :allTargets :json-false)
      :inlayHints (:enable :json-false)
      :diagnostics (:experimental (:enable :json-false))
      :files (:excludeDirs ["target" "**/target" ".git" "node_modules"])))))
